## 6. Local Ingress

Creating a meaningful local ingress configuration requires a few specific steps.  

*minikube loadbalancing*  

These local configuration and development examples assume you are using the minikube tunnel feature to simulate a loadbalancer that istio will use for the ingressgateway service. See the [all-in-one kubernetes setup guide](doc/kubernetes.md).  

*.localhost will used as the local domain thoughout this guide, though you may substitute for whatever domain you want.

You can simple edit the `hostfile` on your local machine to include a specific domain. The first deployment in these example uses httpbin and you could just add a hostfile entry of `X.X.X.X httpbin.localhost` substituting the ClusterIP used by the istio ingressgateway.  

[hostess](https://github.com/cbednarski/hostess) is a small utility that can make that kind of hostfile management easier on macos. Must run as `sudo` to edit the locahost file (as you would expect).    

**deploy httpbin**  

```bash
$ inv deploy.httpbin
```

This non-tls example uses simple http. The deployment files are configured to use .localhost, if you used a different local domain you must update the gateway and virtual-service deployment files to match.  

Once deployed, you can access via your browser at http://httpbin.localhost  

**deploy httpbin with tls**  

[`mkcert`](https://github.com/FiloSottile/mkcert) is used in these examples as a local Root CA. Be sure to review the README for this utility for securitiy concerns. tl;dr don't let cert or keys generated by mkcert leave your computer.

This tls deployment will use mkcert to create certificates for httpbin.localhost. Use homebrew to install mkcert and then create the Root CA  

```bash
$ mkcert -install
```
Now deploy the https configuration for httpbin:  

```bash
$ inv deploy.httpbin --tls
```

You can now access at https://httpbin.localhost  

Use curl to display header and certificate validation info  
```bash
$ curl -v -HHost:httpbin.localhost --cacert httpbin.localhost.crt "https://httpbin.localhost/status/418"
```

You should see something like the following:  (different IPs)
```bash
*   Trying 10.99.79.111...
* TCP_NODELAY set
* Connected to httpbin.localhost (10.99.79.111) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: httpbin.localhost.crt
  CApath: none
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
* TLSv1.2 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-CHACHA20-POLY1305
* ALPN, server accepted to use h2
* Server certificate:
*  subject: O=mkcert development certificate; OU=<username>@<your computer>
*  start date: Jun  1 00:00:00 2019 GMT
*  expire date: Jul 25 18:41:37 2030 GMT
*  subjectAltName: host "httpbin.localhost" matched cert's "httpbin.localhost"
*  issuer: O=mkcert development CA; OU=<username>@<your computer>; CN=mkcert <username>@<your computer>
*  SSL certificate verify ok.
* Using HTTP2, server supports multi-use
* Connection state changed (HTTP/2 confirmed)
* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: len=0
* Using Stream ID: 1 (easy handle 0x7fe0d180f600)
> GET /status/418 HTTP/2
> Host:httpbin.localhost
> User-Agent: curl/7.64.1
> Accept: */*
>
* Connection state changed (MAX_CONCURRENT_STREAMS == 2147483647)!
< HTTP/2 418
< server: istio-envoy
< date: Sat, 25 Jul 2020 18:49:42 GMT
< x-more-info: http://tools.ietf.org/html/rfc2324
< access-control-allow-origin: *
< access-control-allow-credentials: true
< content-length: 135
< x-envoy-upstream-service-time: 15
<

    -=[ teapot ]=-

       _...._
     .'  _ _ `.
    | ."` ^ `". _,
    \_;`"---"`|//
      |       ;/
      \_     _/
        `"""`
* Connection #0 to host httpbin.localhost left intact
* Closing connection 0
```

**clean up**
```bash
$ inv delete.httpbin
```
